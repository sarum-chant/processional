\PassOptionsToPackage{unicode,pdfusetitle,pdflang=la,hidelinks}{hyperref}
\documentclass[
  fontsize=14pt,
  paper=letter,
  DIV=12,
  headings=normal,
  parskip=never]
{scrbook}

\usepackage[autocompile]{gregoriotex}
\usepackage{unicode-math}
\usepackage{microtype}
\usepackage[open]{bookmark}
\usepackage{xurl}
\usepackage{marginnote}

\usepackage[canadian, latin]{babel}

\addto\captionslatin{
  \RenewDocumentCommand\contentsname{}
    {Tabula contentorum}
}

\defaultfontfeatures{Scale=MatchLowercase}
\defaultfontfeatures[\rmfamily]{Ligatures=TeX,Scale=1}
\setmainfont{JuniusX}[
  UprightFont = {*-Regular},
  ItalicFont = {Junicode-Italic}, % until JuniusX italic available
  BoldFont = {*-Semibold},
  BoldItalicFont = {Junicode-BoldItalic},
  Numbers={Lowercase,Proportional},
  StylisticSet = 18, % old-style punctuation spacing
  UprightFeatures={
    SizeFeatures={
      {Size={-10.99},   Font=*-Medium},
      {Size={11-23.99}, Font=*-Regular},
      {Size={24-},      Font=*-Light}
    },
  },
]
% \setmainfont{ElstobD}[
%   UprightFont = {*-Regular},
%   ItalicFont = {*-Italic},
%   BoldFont = {*-SemiBold},
%   BoldItalicFont = {*-SemiBoldItalic},
%   Numbers={Lowercase,Proportional},
%   UprightFeatures={
%     SizeFeatures={
%       {Size={-8.5},      Font=*-8pt},
%       {Size={8.6-10.99}, Font=*-10pt},
%       {Size={11-14.5},   Font=*-14pt},
%       {Size={14.6-21.59},Font=*-18pt},
%       {Size={21.6-35.99},Font=*-Light},
%       {Size={36-},       Font=*-ExtraLight}
%     },
%   },
%   ItalicFeatures={
%     SizeFeatures={
%       {Size={-8.5},      Font=*-8ptItalic},
%       {Size={8.6-10.99}, Font=*-10ptItalic},
%       {Size={11-14.5},   Font=*-14ptItalic},
%       {Size={14.6-21.59},Font=*-18ptItalic},
%       {Size={21.6-35.99},Font=*-LightItalic},
%       {Size={36-},       Font=*-ExtraLightItalic}
%     },
%   },
%   BoldFeatures={
%     SizeFeatures={
%       {Size={-8.5},      Font=*-8ptSemiBold},
%       {Size={8.6-10.99}, Font=*-10ptSemiBold},
%       {Size={11-14.5},   Font=*-14ptSemiBold},
%       {Size={14.6-},     Font=*-18ptSemiBold}
%     },
%   },
%   BoldItalicFeatures={
%     SizeFeatures={
%       {Size={-8.5},      Font=*-8ptSemiBoldItalic},
%       {Size={8.6-10.99}, Font=*-10ptSemiBoldItalic},
%       {Size={11-14.5},   Font=*-14ptSemiBoldItalic},
%       {Size={14.6-},     Font=*-18ptSemiBoldItalic}
%     },
%   }
% ]

% Decorative fonts
\newfontfamily\gothic{DS Caslon Gotisch}[Scale=1]
\newfontfamily\lombardic{Luminari}
\newfontfamily\woodcut{TypographerWoodcutInitialsOne}

% heading formatting
\setcounter{secnumdepth}{-\maxdimen} % remove section numbers
\RenewDocumentCommand\raggedsection{}
  {\centering} % centre all headings
\addtokomafont{disposition}{\normalfont\color{gregoriocolor}} % all headings in red (gregoriocolor = rubric colour)
\addtokomafont{caption}{\color{gregoriocolor}}
\addtokomafont{pageheadfoot}{\normalfont\color{gregoriocolor}}
\addtokomafont{pagenumber}{\color{gregoriocolor}}
\RenewDocumentCommand\marginfont{}
  {\noindent\rule{0pt}{0.7\baselineskip}\color{black}\footnotesize}

% title page formatting
\addtokomafont{subject}{\normalfont\scshape\addfontfeatures{Letters=UppercaseSmallCaps}\Huge}
\addtokomafont{publishers}{\scshape\addfontfeatures{Letters=UppercaseSmallCaps}}
\addtokomafont{date}{\scshape\addfontfeatures{Letters=UppercaseSmallCaps}}

\RedeclareSectionCommand[afterskip=1sp]{subsubsection}

% Line spacing
\usepackage{setspace}
\setstretch{1.2}
\raggedbottom

% Columns with vertical rule
\usepackage{multicol}
\setlength{\columnsep}{1.5pc}
\setlength{\columnseprule}{0.7pt}

% Drop caps
\usepackage{lettrine}
\LettrineRealHeighttrue
\RenewDocumentCommand\LettrineTextFont{}
  {\MakeUppercase} % make word following cap all caps
\RenewDocumentCommand\LettrineFontHook{}
  {\color{gregoriocolor}}
\setlength{\DefaultNindent}{0em}

\urlstyle{same} % disable monospaced font for URLs

\setlength{\emergencystretch}{3em} % prevent overfull lines

% Move footnote marker into left margin
\deffootnote{0em}{1.6em}{\thefootnotemark\enskip}
\setfootnoterule{0pt} % Remove footnote rule

% use all small caps for \textsc
\RenewDocumentCommand\textsc{m}
  {{\scshape\addfontfeatures{Letters=UppercaseSmallCaps}#1}}

% Font substitution
\usepackage{newunicodechar}
\newfontfamily{\coelacanth}{Coelacanth}
\newunicodechar{â™­}{{\coelacanth â™­}}

\newunicodechar{â„£}{\textsc{â„£}}
\newunicodechar{â„Ÿ}{\textsc{â„Ÿ}}

\newfontfamily{\jenson}{Adobe Jenson Pro}
\newunicodechar{Â¶}{{\jenson Â¶}}

% TODO: licence for commercial use of Brill requested; alternatively STIX Two Math renders the character this way, but it needs to be raised to sit on the baseline
\newfontfamily{\brill}{Brill}
\newunicodechar{âœ }{{\brill âœ }}
\newunicodechar{ð”„}{{\brill ð”„}}
\newunicodechar{ð”ˆ}{{\brill ð”ˆ}}
\newunicodechar{ð”’}{{\brill ð”’}}

% Endnotes
\usepackage{enotez}
\setenotez{
  list-name={Notae},
  % backref=true % causing spacing issues
}
\AtEveryEndnotesList{
  \markboth{Notae}{Notae}
  \setlength{\columnsep}{2pc}
  \setlength{\columnseprule}{0pt}
  \begin{multicols}{2}
}
\AfterEveryEndnotesList{\end{multicols}}
\let\footnote=\endnote % turn footnotes into endnotes

% remove figure numbers
\RenewDocumentCommand\figureformat{}{}
\RenewDocumentCommand\captionformat{}{}

% Graphics
\usepackage{graphicx}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}


% Gregorio settings
\gresetgregpath{{./scores/}}

\grechangestaffsize{20} % larger staff
\grechangedim{spacebeneathtext}{1ex}{scalable}

\grechangestyle{initial}{\woodcut\fontsize{90}{90}\selectfont}
\grechangestyle{commentary}{\footnotesize}
\grechangestyle{annotation}{\footnotesize}
\grechangestyle{abovelinestext}{\scriptsize}
\grechangestyle{firstsyllableinitial}{\MakeUppercase}
\grechangedim{annotationraise}{0mm}{scalable}
\grechangedim{commentaryraise}{5mm}{scalable}
\grechangedim{abovelinestextraise}{5mm}{scalable}

% coloured chant
\let\emph\relax % rubrics in red
  \DeclareTextFontCommand{\emph}{\color{gregoriocolor}}
\gresetlinecolor{gregoriocolor} % staff lines in red
\RenewDocumentCommand\GreStar{}
  {{\color{gregoriocolor}*}}
\RenewDocumentCommand\GreDagger{}
  {{\color{gregoriocolor}â€ }}
\gresetspecial{â„£.}{{\color{gregoriocolor}\textsc{â„£.}}}
\gresetspecial{â„Ÿ.}{{\color{gregoriocolor}\textsc{â„Ÿ.}}}
\gresetspecial{Ps.}{{\color{gregoriocolor}Ps.}}
\newunicodechar{â€ }{{\color{gregoriocolor}â€ }}
\newunicodechar{â€¡}{{\color{gregoriocolor}â€¡}}
\newunicodechar{â¹‹}{{\color{gregoriocolor}â¹‹}}

% styles for chant lines
\NewDocumentEnvironment{noinitial}{}
  {\gresetinitiallines{0}\grechangestyle{firstsyllableinitial}{}}
  {}
\NewDocumentEnvironment{largeinitial}{}
  {\grechangestyle{initial}{\woodcut\fontsize{120}{120}\selectfont}}
  {}

% chant headers
\NewDocumentCommand\cantusmargin{m}
  {\marginnote{\href{http://cantusindex.org/id/#1}{#1}}}
\gresetheadercapture{cantus}{cantusmargin}{string}
\gresetheadercapture{commentary}{grecommentary}{}

% two-column text layout
\NewDocumentEnvironment{lesson}{}
  {\begin{multicols}{2}
  \RenewDocumentCommand\LettrineFontHook{}
    {\lombardic\color{gregoriocolor}}
  \setcounter{DefaultLines}{2}}
  {\end{multicols}}

\NewDocumentCommand\newrubric{}
  {\hfill \break \noindent}

\input{ushyphex} % standard English exceptions

\recalctypearea

\begin{document}

\frontmatter

\extratitle{
  \begin{figure}
  \centering
  \includegraphics[height=0.7\textheight]{images/1r-title.png}
  % \caption{Oxford, Bodleian Library, Gough Missals 75, fol. 1r}
  \end{figure}
}

\frontispiece{%
    {\gothic\Large\par

    \begin{minipage}[t]{\textwidth}
      Â¶ Processionale ad vsum insignis ac preclare ecclesie Sarum nouiter ac rursus castigatum per excellentissimum ac vigilantissimum et reuerendissimum In Christo patrem Dominum nostrum dominum episcopum de Wyntonii feliciter incipit. Parisiensis impressum per Wolfgangum Hopylium impensis honesti viri Francisci Bryckman ciuis Coloniensis. Anno Domini M.CCCCC.xix. Die vero xxviij. Octobris.
    \end{minipage}
    \vfill
    \begin{minipage}[b]{\textwidth}
      Venundantur Londonii apud Franciscum Bryckman, in cimiterio sancti Pauli.
    \end{minipage}}
}

\title{Processionale ad usum Sarum}

\author{edited by\\William Renwick\\Brandon Wild\\Andrew Dunning}

\date{MMXXI}

\publishers{Gregorian Institute of Canada}

\lowertitleback{
\KOMAoptions{parskip=half}

\begin{otherlanguage}{canadian}
Â© 2021 Gregorian Institute of Canada

School of the Arts, McMaster University, 1280 Main Street West, Hamilton, Ontario, \textsc{L8S 4L8}, Canada

\url{http://sarum-chant.ca}

Images courtesy of the Bodleian Library, University of Oxford.
\end{otherlanguage}
}

\maketitle

\tableofcontents

\listoffigures

\include{processionale-0-intro}

\mainmatter

\include{processionale-1-advent}

% \include{processionale-2-christmas}
%
% \include{processionale-3-epiphany}
%
% \include{processionale-4-lent}
%
% \include{processionale-5-holy-week}
%
% \include{processionale-6-paschaltide}
%
% \include{processionale-7-trinity}
%
% \include{processionale-8-proper}
%
% \include{processionale-9-common}

\backmatter

\printendnotes

\end{document}
