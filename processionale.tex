\PassOptionsToPackage{unicode,pdfusetitle,pdflang=la,hidelinks}{hyperref}
\documentclass[
  fontsize=14pt,
  paper=letter,
  DIV=12,
  headings=normal,
  parskip=never]
{scrbook}

\usepackage[autocompile]{gregoriotex}
\usepackage{unicode-math}
\usepackage{microtype}
\usepackage{xurl}
\usepackage{marginnote}
\usepackage[imakeidx]{xindex}
\makeindex[title=Index of incipits]
\usepackage[open]{bookmark}

\usepackage[canadian, latin]{babel}

\addto\captionslatin{
  \RenewDocumentCommand\contentsname{}
    {Tabula contentorum}
}

\defaultfontfeatures{Scale=MatchLowercase}
\defaultfontfeatures[\rmfamily]{Ligatures=TeX,Scale=1}
\setmainfont{JuniusX}[
  UprightFont = {*-Regular},
  ItalicFont = {Junicode-Italic}, % until JuniusX italic available
  BoldFont = {*-Semibold},
  BoldItalicFont = {Junicode-BoldItalic},
  Numbers={Lowercase,Proportional},
  StylisticSet = 18, % old-style punctuation spacing
  UprightFeatures={
    SizeFeatures={
      {Size={-10.99},   Font=*-Medium},
      {Size={11-23.99}, Font=*-Regular},
      {Size={24-},      Font=*-Light}
    },
  },
]
% \setmainfont{ElstobD}[
%   UprightFont = {*-Regular},
%   ItalicFont = {*-Italic},
%   BoldFont = {*-SemiBold},
%   BoldItalicFont = {*-SemiBoldItalic},
%   Numbers={Lowercase,Proportional},
%   UprightFeatures={
%     SizeFeatures={
%       {Size={-8.5},      Font=*-8pt},
%       {Size={8.6-10.99}, Font=*-10pt},
%       {Size={11-14.5},   Font=*-14pt},
%       {Size={14.6-21.59},Font=*-18pt},
%       {Size={21.6-35.99},Font=*-Light},
%       {Size={36-},       Font=*-ExtraLight}
%     },
%   },
%   ItalicFeatures={
%     SizeFeatures={
%       {Size={-8.5},      Font=*-8ptItalic},
%       {Size={8.6-10.99}, Font=*-10ptItalic},
%       {Size={11-14.5},   Font=*-14ptItalic},
%       {Size={14.6-21.59},Font=*-18ptItalic},
%       {Size={21.6-35.99},Font=*-LightItalic},
%       {Size={36-},       Font=*-ExtraLightItalic}
%     },
%   },
%   BoldFeatures={
%     SizeFeatures={
%       {Size={-8.5},      Font=*-8ptSemiBold},
%       {Size={8.6-10.99}, Font=*-10ptSemiBold},
%       {Size={11-14.5},   Font=*-14ptSemiBold},
%       {Size={14.6-},     Font=*-18ptSemiBold}
%     },
%   },
%   BoldItalicFeatures={
%     SizeFeatures={
%       {Size={-8.5},      Font=*-8ptSemiBoldItalic},
%       {Size={8.6-10.99}, Font=*-10ptSemiBoldItalic},
%       {Size={11-14.5},   Font=*-14ptSemiBoldItalic},
%       {Size={14.6-},     Font=*-18ptSemiBoldItalic}
%     },
%   }
% ]

% Decorative fonts
\newfontfamily\gothic{DS Caslon Gotisch}[Scale=1]
\newfontfamily\lombardic{Luminari}
\newfontfamily\woodcut{TypographerWoodcutInitialsOne}

% heading formatting
\setcounter{secnumdepth}{-\maxdimen} % remove section numbers
\RenewDocumentCommand\raggedsection{}
  {\centering} % centre all headings
\addtokomafont{disposition}{\normalfont\color{gregoriocolor}} % all headings in red (gregoriocolor = rubric colour)
\addtokomafont{caption}{\color{gregoriocolor}}
\addtokomafont{pageheadfoot}{\normalfont\color{gregoriocolor}}
\addtokomafont{pagenumber}{\color{gregoriocolor}}
\RenewDocumentCommand\marginfont{}
  {\noindent\rule{0pt}{0.7\baselineskip}\color{black}\footnotesize}

% title page formatting
\addtokomafont{subject}{\normalfont\scshape\addfontfeatures{Letters=UppercaseSmallCaps}\Huge}
\addtokomafont{publishers}{\scshape\addfontfeatures{Letters=UppercaseSmallCaps}}
\addtokomafont{date}{\scshape\addfontfeatures{Letters=UppercaseSmallCaps}}

\RedeclareSectionCommand[afterskip=1sp]{subsubsection}

% Line spacing
\usepackage{setspace}
\setstretch{1.2}
\raggedbottom

% Columns with vertical rule
\usepackage{multicol}
\setlength{\columnsep}{1.5pc}
\setlength{\columnseprule}{0.7pt}

% Drop caps
\usepackage{lettrine}
\LettrineRealHeighttrue
\RenewDocumentCommand\LettrineTextFont{}
  {\MakeUppercase} % make word following cap all caps
\RenewDocumentCommand\LettrineFontHook{}
  {\color{gregoriocolor}}
\setlength{\DefaultNindent}{0em}

\urlstyle{same} % disable monospaced font for URLs

\setlength{\emergencystretch}{3em} % prevent overfull lines

% Move footnote marker into left margin
\deffootnote{0em}{1.6em}{\thefootnotemark\enskip}
\setfootnoterule{0pt} % Remove footnote rule

% use all small caps for \textsc
\RenewDocumentCommand\textsc{m}
  {{\scshape\addfontfeatures{Letters=UppercaseSmallCaps}#1}}

% Font substitution
\usepackage{newunicodechar}
\newfontfamily{\coelacanth}{Coelacanth}
\newunicodechar{♭}{{\coelacanth ♭}}

\newunicodechar{℣}{\textsc{℣}}
\newunicodechar{℟}{\textsc{℟}}

\newfontfamily{\jenson}{Adobe Jenson Pro}
\newunicodechar{¶}{{\jenson ¶}}

% TODO: licence for commercial use of Brill requested; alternatively STIX Two Math renders the character this way, but it needs to be raised to sit on the baseline
\newfontfamily{\brill}{Brill}
\newunicodechar{✠}{{\brill ✠}}
\newunicodechar{𝔄}{{\brill 𝔄}}
\newunicodechar{𝔈}{{\brill 𝔈}}
\newunicodechar{𝔒}{{\brill 𝔒}}

% Endnotes
\usepackage{enotez}
\setenotez{
  list-name={Notae},
  % backref=true % causing spacing issues
}
\AtEveryEndnotesList{
  \markboth{Notae}{Notae}
  \setlength{\columnsep}{2pc}
  \setlength{\columnseprule}{0pt}
  \begin{multicols}{2}
  \begin{noinitial}
  \grechangestaffsize{15}
}
\AfterEveryEndnotesList{\end{noinitial}\end{multicols}}

% remove figure numbers
\RenewDocumentCommand\figureformat{}{}
\RenewDocumentCommand\captionformat{}{}

% Graphics
\usepackage{graphicx}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}


% Gregorio settings
\gresetgregpath{{./scores/}}

\grechangestaffsize{20} % larger staff
\grechangedim{annotationraise}{1ex}{scalable}
\grechangedim{commentaryraise}{4ex}{scalable}
\grechangedim{parskip}{2ex}{scalable}
\grechangedim{spacebeneathtext}{1ex}{scalable}

\grechangestyle{abovelinestext}{\footnotesize}
\grechangestyle{annotation}{\footnotesize\selectfont}
\grechangestyle{commentary}{\footnotesize\selectfont}
\grechangestyle{firstsyllableinitial}{\MakeUppercase}
\grechangestyle{initial}{\woodcut\fontsize{90}{90}\selectfont}

% coloured chant
\let\emph\relax % rubrics in red
  \DeclareTextFontCommand{\emph}{\color{gregoriocolor}}
\gresetlinecolor{gregoriocolor} % staff lines in red
\RenewDocumentCommand\GreStar{}
  {{\color{gregoriocolor}*}}
\RenewDocumentCommand\GreDagger{}
  {{\color{gregoriocolor}†}}
\gresetspecial{℣.}{{\color{gregoriocolor}\textsc{℣.}}}
\gresetspecial{℟.}{{\color{gregoriocolor}\textsc{℟.}}}
\gresetspecial{Ps.}{{\color{gregoriocolor}Ps.}}
\gresetspecial{ij.}{{\color{gregoriocolor}ij.}}
\gresetspecial{iij.}{{\color{gregoriocolor}iiij.}}
\gresetspecial{Chorus.}{{\color{gregoriocolor}Chorus.}}
\newunicodechar{†}{{\color{gregoriocolor}†}}
\newunicodechar{‡}{{\color{gregoriocolor}‡}}
\newunicodechar{⹋}{{\color{gregoriocolor}⹋}}

% styles for chant lines
\NewDocumentEnvironment{noinitial}{}
  {\gresetinitiallines{0}\grechangestyle{firstsyllableinitial}{}}
  {}
\NewDocumentEnvironment{largeinitial}{}
  {\grechangestyle{initial}{\woodcut\fontsize{120}{120}\selectfont}}
  {}

% chant headers
\NewDocumentCommand\cantusnote{m}
  {\marginnote{\href{http://cantusindex.org/id/#1}{#1}}}
\gresetheadercapture{name}{index}{string}
\gresetheadercapture{cantus}{cantusnote}{string}
\gresetheadercapture{commentary}{grecommentary}{}

% two-column text layout
\NewDocumentEnvironment{lesson}{}
  {\begin{multicols}{2}
  \RenewDocumentCommand\LettrineFontHook{}
    {\lombardic\color{gregoriocolor}}
  \setcounter{DefaultLines}{2}}
  {\end{multicols}}

\NewDocumentCommand\newrubric{}
  {\hfill \break \noindent}

\input{ushyphex} % standard English exceptions

\recalctypearea

\begin{document}

\frontmatter

\frontispiece{%
  \centering
  \includegraphics[height=0.9\textheight]{images/1r-title.png}
  % Oxford, Bodleian Library, Gough Missals 75, fol. 1r
}

\title{Processionale ad usum Sarum}

\author{edited by\\William Renwick\\Brandon Wild\\Andrew Dunning}

\date{MMXXI}

\publishers{Gregorian Institute of Canada}

\lowertitleback{
\KOMAoptions{parskip=half}

\begin{otherlanguage}{canadian}
© 2021 Gregorian Institute of Canada

School of the Arts, McMaster University, 1280 Main Street West, Hamilton, Ontario, \textsc{L8S 4L8}, Canada

\url{http://sarum-chant.ca}

Images courtesy of the Bodleian Library, University of Oxford.
\end{otherlanguage}
}

\maketitle

\tableofcontents

\listoffigures

\include{processionale-0-intro}

\begin{figure}
\thispagestyle{empty}
\centering
\includegraphics{images/1v-statio-aqua.png}
\caption{¶ Statio dum benedicitur aqua benedicta in omnibus dominicis.}
\end{figure}

\mainmatter

\let\footnote=\endnote % turn footnotes into endnotes

\include{processionale-1-advent}

\include{processionale-2-christmas}

\include{processionale-3-epiphany}

\include{processionale-4-lent}

\include{processionale-5-holy-week}

\include{processionale-6-paschaltide}

\include{processionale-7-trinity}

\include{processionale-8-proper}

\include{processionale-9-common}

\backmatter

\printendnotes

\printindex

\end{document}
